@startuml

title EVENTOS Data Model (DB Schema + API Populate Strategy)

skinparam shadowing true
skinparam classAttributeIconSize 0
'skinparam wrapWidth 320
'skinparam linetype ortho
left to right direction
hide empty methods

!define COLLECTION <<collection>>
!define DB <<db>>

note top of Events
**POPULATE STRATEGY (API Responses)**
====
All API endpoints return **populated objects**
instead of IDs for references:
- Expenses: payer, store?, unit? (objects)
- Reservations: salesperson?, consumptionType,
  pickupPoint?, paymentMethod, cashier? (objects)
- Products: promotions[] (objects)
- Promotions: applicables[] (objects)

**DB Storage**: Still uses ObjectId references
**API Output**: Returns full embedded objects

See docs/populate-strategy.md for details
end note

' ================= ENTIDADES =================

class Events DB {
  id: string
  createdAt: Date
  updatedAt: Date
  isActive: boolean
  name: string
  date: Date
  capacity?: Integer
  capitalAmount?: Decimal (7,2)
}

class Reservations COLLECTION {
  id: string
  eventId: string
  createdAt: Date
  updatedAt: Date
  notes?: string
  isActive: boolean
  reserver: string
  order: object //{[productId: string]: qty: Integer}
  totalAmount: Decimal (7,2)
  salespersonId?: string
  consumptionTypeId: string
  pickupPointId?: string
  hasPromoApplied: boolean
  linkedReservations?: array [ReservationIds..]
  deposit?: Decimal (7,2)
  isDelivered: boolean
  isPaid: boolean
  paymentMethodId: string
  cashierId?: string
  appliedPromotionsSnapshot?: array [ProductPromotionSnapshot..]
}

class Products COLLECTION {
  id: string
  eventId: string
  createdAt: Date
  updatedAt: Date
  notes?: string
  isActive: boolean
  name: string
  description?: string
  stock: Integer
  promotions?: string [Promotions..]
  nominalPrice?: Decimal (7,2)
  supplement?: object {ConsumptionTypeId:cents}
}

class Promotions COLLECTION {
  id: string
  eventId: string
  createdAt: Date
  updatedAt: Date
  isActive: boolean
  name: string
  description?: string
  applicables?: string [ProductIds..]
  rule: enum Rules
  conditions?: object  ' JSON dinámico según rule
  startDate: Date
  endDate: Date
  priority: Integer
  isCumulative: boolean
}



class Expenses COLLECTION {
  id: string
  eventId: string
  createdAt: Date
  updatedAt: Date
  notes?: string
  isActive: boolean
  ingredient: string
  unitId?: string
  quantity?: Decimal (5,2)
  basePrice: Decimal (7,2)
  vatPct: enum{0%,4%,10%,21%}
  vatAmount: Decimal (7,2)
  netPrice: Decimal (7,2)
  isPackage: boolean
  unitsPerPack?: Integer
  unitPrice?: Decimal (7,2)
  payerId: string
  storeId?: string
  isVerified: boolean
}

class Salespeople COLLECTION {
  id: string
  eventId: string
  createdAt: Date
  updatedAt: Date
  notes?: string
  isActive: boolean
  name: string
  phone: string
}

class PaymentMethods COLLECTION {
   id: string
   eventId: string
   createdAt: Date
   updatedAt: Date
   notes?: string
   isActive: boolean
   name: string
}

class Cashiers COLLECTION {
  id: string
  eventId: string
  createdAt: Date
  updatedAt: Date
  notes?: string
  isActive: boolean
  name: string
  phone: string
}

class Stores COLLECTION {
  id: string
  eventId: string
  createdAt: Date
  updatedAt: Date
  notes?: string
  isActive: boolean
  name: string
  seller?: string
  phone?: string
  address?: string
  email?: string
  openingHours?:string
}

class Units COLLECTION {
  id: string
  eventId: string
  createdAt: Date
  updatedAt: Date
  notes?: string
  isActive: boolean
  name: string
  abbreviation: string
}

class ConsumptionTypes COLLECTION {
  id: string
  eventId: string
  createdAt: Date
  updatedAt: Date
  notes?: string
  isActive: boolean
  name: string
}

class Payers COLLECTION {
  id: string
  eventId: string
  createdAt: Date
  updatedAt: Date
  notes?: string
  isActive: boolean
  name: string
  phone?: string
}

class PickupPoints COLLECTION {
  id: string
  eventId: string
  createdAt: Date
  updatedAt: Date
  notes?: string
  isActive: boolean
  name: string
  dealerName?: string
  phone?: string
  address?: string
  email?: string
  openingHours?:string
}

class Partners COLLECTION {
  id: string
  eventId: string
  createdAt: Date
  updatedAt: Date
  notes?: string
  isActive: boolean
  name: string
  stake: Decimal (5,2)
  phone?: string
  email?: string
}

Enum Rules {
  XForY
  DiscountPerUnit
  BulkPrice
  PercentageDiscount
  ComboDiscount
  FixedPriceBundle
  BuyXGetYFree
  MaxUnitsDiscounted
  FirstXUnitsFree
  TimeLimitedDiscount
}


' ================= RELACIONES =================

'Event → resto (1 a muchos)
Events "1" --> "0..*" Reservations : eventId
Events "1" --> "0..*" Products : eventId
Events "1" --> "0..*" Promotions : eventId
Events "1" --> "0..*" Expenses : eventId
Events "1" --> "0..*" Salespeople : eventId
Events "1" --> "0..*" PaymentMethods : eventId
Events "1" --> "0..*" Cashiers : eventId
Events "1" --> "0..*" Stores : eventId
Events "1" --> "0..*" Units : eventId
Events "1" --> "0..*" ConsumptionTypes : eventId
Events "1" --> "0..*" Payers : eventId
Events "1" --> "0..*" PickupPoints : eventId
Events "1" --> "0..*" Partners : eventId


' Reservas → metadatos opcionales
Reservations --> "1" Salespeople : salespersonId
Reservations --> "1" ConsumptionTypes : consumptionTypeId
Reservations --> "0..1" PickupPoints : pickupPointId
Reservations --> "1" PaymentMethods : paymentMethodId
Reservations --> "1" Cashiers : cashierId
Reservations ..> Products : keys(order) (productId)


' Gastos → metadatos opcionales
Expenses --> "0..1" Units : unitId
Expenses --> "1" Payers : payerId
Expenses --> "0..1" Stores : storeId


Rules --o Promotions
Conditions --o Promotions

' ===== Snapshot Structures =====
class ProductPromotionSnapshot {
  +productId: string
  +productName: string
  +quantity: int
  +unitPriceOriginal: Decimal (7,2)
  +unitPriceFinal: Decimal (7,2)
  +subtotal: Decimal (7,2)
  +promotionsApplied: AppliedPromotionSnapshot[*]
}

class AppliedPromotionSnapshot {
  +promotionId: string
  +promotionName: string
  +rule: string
  +discountPerUnit: Decimal (7,2)
}

ProductPromotionSnapshot *-- AppliedPromotionSnapshot
Reservations ..> ProductPromotionSnapshot : appliedPromotionsSnapshot




' ===== Core =====
class Conditions {
    ***** validar que no haya solapamiento de reglas
}

' ===== Conditions por Regla (simplificadas según schema real) =====
class XForYConditions {
  +_rule: "XForY"
  +buyQty: int  ' Cantidad a comprar (ej: 3)
  +payQty: int  ' Cantidad a pagar (ej: 2)
}

class DiscountPerUnitConditions {
  +_rule: "DiscountPerUnit"
  +amountOff: Decimal (7,2)  ' Descuento por unidad
}

class BulkPriceConditions {
  +_rule: "BulkPrice"
  +units: int  ' Unidades en el bloque
  +bundlePrice: Decimal (7,2)  ' Precio total del bloque
}

class PercentageDiscountConditions {
  +_rule: "PercentageDiscount"
  +percent: int  ' Porcentaje de descuento (0-100)
}

class ComboDiscountConditions {
  +_rule: "ComboDiscount"
  +requiredProductIds: string[*]  ' Mínimo 2 productos
  +percent?: int  ' Porcentaje de descuento (opcional)
  +amountOff?: Decimal (7,2)  ' Descuento fijo (opcional)
}

class FixedPriceBundleConditions {
  +_rule: "FixedPriceBundle"
  +productIds: string[*]  ' Productos del bundle
  +price: Decimal (7,2)  ' Precio fijo total
}

class BuyXGetYFreeConditions {
  +_rule: "BuyXGetYFree"
  +buyQty: int  ' Cantidad a comprar
  +freeQty: int  ' Cantidad gratis
}

class MaxUnitsDiscountedConditions {
  +_rule: "MaxUnitsDiscounted"
  +maxUnits: int  ' Máximo de unidades con descuento
  +percent?: int  ' Porcentaje de descuento (opcional)
  +amountOff?: Decimal (7,2)  ' Descuento fijo (opcional)
}

class FirstXUnitsFreeConditions {
  +_rule: "FirstXUnitsFree"
  +units: int  ' Número de unidades gratis
}

class TimeLimitedDiscountConditions {
  +_rule: "TimeLimitedDiscount"
  +percent?: int  ' Porcentaje de descuento (opcional)
  +amountOff?: Decimal (7,2)  ' Descuento fijo (opcional)
}

' ===== Mapeo rule -> conditions (informativo) =====
Conditions --> XForYConditions : rule=XForY
Conditions --> DiscountPerUnitConditions : rule=DiscountPerUnit
Conditions --> BulkPriceConditions : rule=BulkPrice
Conditions --> PercentageDiscountConditions : rule=PercentageDiscount
Conditions --> ComboDiscountConditions : rule=ComboDiscount
Conditions --> FixedPriceBundleConditions : rule=FixedPriceBundle
Conditions --> BuyXGetYFreeConditions : rule=BuyXGetYFree
Conditions --> MaxUnitsDiscountedConditions : rule=MaxUnitsDiscounted
Conditions --> FirstXUnitsFreeConditions : rule=FirstXUnitsFree
Conditions --> TimeLimitedDiscountConditions : rule=TimeLimitedDiscount



note bottom of Reservations
order es un mapa productId→qty.
Validar: productos existen, mismo eventId,
qty > 0 y reglas de negocio antes de confirmar.
end note

@enduml